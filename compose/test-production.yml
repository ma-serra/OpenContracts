services:
  traefik:
    # Override the production traefik config for testing with file-based config and local TLS
    command:
      - --log.level=DEBUG
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.file.filename=/etc/traefik/traefik.yml
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
      - --entrypoints.web-secure.address=:443
      - --entrypoints.flower.address=:5555
      # Redirect HTTP to HTTPS
      - --entrypoints.web.http.redirections.entryPoint.to=web-secure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
    volumes:
      - ./compose/production/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./contrib/certs:/etc/certs:ro
    ports:
      - "80:80"
      - "443:443"
      - "5555:5555"
      - "8080:8080"  # Traefik dashboard for debugging

  # Override environment variables for testing
  django:
    environment:
      - DJANGO_DEBUG=False
      - DJANGO_ALLOWED_HOSTS=opencontracts.opensource.legal,localhost,127.0.0.1
      - USE_TLS=False

  frontend:
    environment:
      - NODE_ENV=production

  redis:
    # Ensure Redis is available for rate limiting
    ports:
      - "6379:6379"  # Expose Redis for debugging if needed
